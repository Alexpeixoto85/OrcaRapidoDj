
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DJ Manager Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            /* Cores Modernas Palette */
            --primary: #3b82f6; /* Azul vibrante */
            --primary-dark: #1d4ed8;
            --secondary: #64748b; /* Slate */
            --accent: #8b5cf6; /* Roxo */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            
            /* Dimensões e Espaçamentos */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(65px + var(--safe-bottom));
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            height: 100vh;
            overflow: hidden; /* App-like feel */
            display: flex;
            flex-direction: column;
            user-select: none; /* Previne seleção de texto acidental no app */
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--safe-top) 16px 10px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--secondary); padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .icon-btn:active { background: #f1f5f9; color: var(--primary); transform: scale(0.95); }

        /* --- Main Content Area --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 80px); /* Extra padding bottom for FAB */
            scroll-behavior: smooth;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--dark); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--secondary); font-weight: 500; }

        /* Colors for Stats */
        .bg-blue { background: #dbeafe; color: var(--primary); }
        .bg-green { background: #d1fae5; color: var(--success); }
        .bg-orange { background: #ffedd5; color: var(--warning); }
        .bg-red { background: #fee2e2; color: var(--danger); }

        /* --- Lists & items --- */
        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .search-container {
            position: relative; margin-bottom: 16px;
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); font-size: 1rem; outline: none;
            -webkit-appearance: none;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--secondary);
        }

        .list-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: transform 0.2s;
        }
        .list-card:active { transform: scale(0.98); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .card-subtitle { font-size: 0.85rem; color: var(--secondary); display: flex; gap: 6px; align-items: center; }
        
        .tag {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 99px;
            font-weight: 600; text-transform: uppercase;
        }
        .tag-pending { background: #fff7ed; color: #c2410c; }
        .tag-accepted { background: #ecfdf5; color: #047857; }
        .tag-rejected { background: #fef2f2; color: #b91c1c; }
        .tag-alert { background: #fee2e2; color: #ef4444; animation: pulse 2s infinite; }

        .card-price { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin-top: 8px; }

        .action-row {
            display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }
        .btn-sm {
            flex: 1; padding: 8px; border-radius: 8px;
            border: none; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
        }
        .btn-light { background: #f1f5f9; color: var(--secondary); }
        .btn-primary-soft { background: #dbeafe; color: var(--primary); }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 50;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #94a3b8; text-decoration: none;
            font-size: 0.7rem; font-weight: 500;
            gap: 4px; transition: 0.2s;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* --- Floating Action Button (FAB) --- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            right: 16px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 40;
            border: none;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        /* --- Modals / Sheets --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 24px 16px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active + .modal-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px; background: #cbd5e1;
            border-radius: 2px; margin: 0 auto 20px;
        }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--dark); }
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }
        textarea.form-control { min-height: 100px; resize: none; }

        .btn-block {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            background: var(--primary); color: white;
            margin-top: 10px;
        }
        
        /* Utility */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; top: var(--header-height); left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-float);
            z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(20px); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-compact-disc" style="color: var(--primary);"></i>
            DJ<span>Manager</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()"><i class="fas fa-cloud-download-alt"></i></button>
            <button class="icon-btn" onclick="UI.openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
    </div>

    <main>
        <div id="dashboard-view" class="view active">
            <div class="section-title">Visão Geral</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.navigate('orcamentos')">
                    <div class="stat-icon bg-blue"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="stat-value" id="dash-total-orcamentos">0</div>
                    <div class="stat-label">Orçamentos</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('clientes')">
                    <div class="stat-icon bg-green"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="dash-total-clientes">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="dash-pendentes">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-red"><i class="fas fa-bell"></i></div>
                    <div class="stat-value" id="dash-followup">0</div>
                    <div class="stat-label">Follow-up</div>
                </div>
            </div>

            <div class="section-title">
                Atenção Necessária
                <span class="tag tag-alert" id="alert-badge" style="display:none">!</span>
            </div>
            <div id="followup-list">
                </div>
        </div>

        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
            </div>
            <div id="clientes-list"></div>
        </div>

        <div id="orcamentos-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar orçamentos..." oninput="UI.renderOrcamentos(this.value)">
            </div>
            <div id="orcamentos-list"></div>
        </div>

        <div id="financeiro-view" class="view">
            <div class="section-title">Resumo Financeiro</div>
            <div class="list-card">
                <div class="card-subtitle">Estimado (Total)</div>
                <div class="card-price" id="fin-total">R$ 0,00</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-check"></i></div>
                    <div class="stat-value" id="fin-aceito" style="font-size: 1.1rem">R$ 0</div>
                    <div class="stat-label">Fechado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-hourglass-half"></i></div>
                    <div class="stat-value" id="fin-pendente" style="font-size: 1.1rem">R$ 0</div>
                    <div class="stat-label">Em Aberto</div>
                </div>
            </div>
        </div>
    </main>

    <button class="fab" onclick="UI.openNewOrcamento()" id="main-fab">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i> <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-user-friends"></i> <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="orcamentos-view" onclick="UI.switchTab(this)">
            <i class="fas fa-file-invoice"></i> <span>Orç.</span>
        </a>
        <a href="#" class="nav-item" data-target="financeiro-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-pie"></i> <span>Finanças</span>
        </a>
    </nav>

    <div class="modal-overlay" id="overlay-cliente"></div>
    <div class="modal-sheet" id="sheet-cliente">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
        <form id="form-cliente" onsubmit="App.cliente.save(event)">
            <input type="hidden" id="c-id">
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="c-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone (WhatsApp)</label>
                <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email (Opcional)</label>
                <input type="email" id="c-email" class="form-control">
            </div>
            <button type="submit" class="btn-block">Salvar Cliente</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <div class="modal-overlay" id="overlay-orcamento"></div>
    <div class="modal-sheet" id="sheet-orcamento">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-orcamento">Novo Orçamento</h3>
        <form id="form-orcamento" onsubmit="App.orcamento.save(event)">
            <input type="hidden" id="o-id">
            
            <div class="form-group">
                <label class="form-label">Cliente</label>
                <div style="display: flex; gap: 8px;">
                    <select id="o-cliente" class="form-control" required style="flex: 1"></select>
                    <button type="button" onclick="UI.openNewCliente(true)" class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px;"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="form-group" style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                    <label class="form-label">Tipo Evento</label>
                    <select id="o-evento" class="form-control">
                        <option value="Casamento">Casamento</option>
                        <option value="Aniversário">Aniversário</option>
                        <option value="15 Anos">15 Anos</option>
                        <option value="Corporativo">Corporativo</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label class="form-label">Data Evento</label>
                    <input type="date" id="o-data" class="form-control" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Valor (R$)</label>
                <input type="text" inputmode="numeric" id="o-valor" class="form-control" placeholder="0,00" required oninput="Utils.maskMoney(this)">
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="o-status" class="form-control">
                    <option value="pendente">Pendente</option>
                    <option value="aceito">Aceito (Fechado)</option>
                    <option value="recusado">Recusado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Validade Orçamento</label>
                <input type="date" id="o-validade" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label">Descrição / Pacote</label>
                <textarea id="o-descricao" class="form-control" placeholder="Sonorização, Iluminação, etc..."></textarea>
            </div>

            <button type="submit" class="btn-block">Salvar Orçamento</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <div class="modal-overlay" id="overlay-settings"></div>
    <div class="modal-sheet" id="sheet-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurações do DJ</h3>
        <form id="form-settings" onsubmit="App.settings.save(event)">
            <div class="form-group">
                <label class="form-label">Nome Artístico / Empresa</label>
                <input type="text" id="s-nome" class="form-control" placeholder="Ex: DJ Show">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone Contato</label>
                <input type="tel" id="s-telefone" class="form-control" oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Cidade</label>
                <input type="text" id="s-cidade" class="form-control">
            </div>
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
            <button type="button" class="btn-block" style="background: var(--danger);" onclick="App.backup.clearData()">
                <i class="fas fa-trash"></i> Resetar Tudo
            </button>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">Importar Backup</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
                <button type="submit" class="btn-block" style="background: var(--primary); margin: 0;">Salvar</button>
            </div>
        </form>
    </div>

    <script>
        // --- UTILITÁRIOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            parseCurrency: (str) => parseFloat(str.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                input.value = v.substring(0, 15);
            },
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2) + "";
                v = v.replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                input.value = v;
            },
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${msg}</span>`;
                t.style.background = type === 'success' ? 'var(--dark)' : 'var(--danger)';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        // --- STORAGE MANAGER ---
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(`djapp_${key}`)) || [],
            set: (key, data) => localStorage.setItem(`djapp_${key}`, JSON.stringify(data)),
            getSettings: () => JSON.parse(localStorage.getItem('djapp_settings')) || { 
                nome: 'Meu DJ', telefone: '', cidade: '', nextOrcamento: 1 
            },
            saveSettings: (data) => localStorage.setItem('djapp_settings', JSON.stringify(data))
        };

        // --- UI MANAGER ---
        const UI = {
            data: { clientes: [], orcamentos: [] },
            
            init: () => {
                UI.data.clientes = Storage.get('clientes');
                UI.data.orcamentos = Storage.get('orcamentos');
                UI.renderDashboard();
                
                // Tabs listeners
                document.querySelectorAll('.bottom-nav .nav-item').forEach(el => {
                    el.addEventListener('click', (e) => e.preventDefault());
                });
            },

            switchTab: (el) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');

                // Toggle FAB visibility
                const fab = document.getElementById('main-fab');
                if(target === 'dashboard-view' || target === 'orcamentos-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewOrcamento;
                } else if (target === 'clientes-view') {
                    fab.style.display = 'flex';
                    fab.onclick = () => UI.openNewCliente(false);
                } else {
                    fab.style.display = 'none';
                }

                if(target === 'clientes-view') UI.renderClientes();
                if(target === 'orcamentos-view') UI.renderOrcamentos();
                if(target === 'financeiro-view') UI.renderFinanceiro();
            },

            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if(el) UI.switchTab(el);
            },

            // --- RENDER FUNCTIONS ---
            renderDashboard: () => {
                const { clientes, orcamentos } = UI.data;
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-orcamentos').innerText = orcamentos.length;
                document.getElementById('dash-pendentes').innerText = orcamentos.filter(o => o.status === 'pendente').length;
                
                // Follow up logic
                const today = new Date().toISOString().split('T')[0];
                const followups = orcamentos.filter(o => 
                    o.status === 'pendente' && (o.validade < today || o.validade === today)
                );
                
                document.getElementById('dash-followup').innerText = followups.length;
                document.getElementById('alert-badge').style.display = followups.length > 0 ? 'inline-block' : 'none';

                const list = document.getElementById('followup-list');
                if(followups.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-thumbs-up"></i><p>Tudo em dia!</p></div>`;
                } else {
                    list.innerHTML = followups.map(o => UI.createOrcamentoCard(o, true)).join('');
                }
            },

            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                const filtered = UI.data.clientes.filter(c => c.nome.toLowerCase().includes(filter.toLowerCase()));
                
                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-user-plus"></i><p>Nenhum cliente encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(c => `
                    <div class="list-card">
                        <div class="card-header">
                            <div class="card-title">${c.nome}</div>
                        </div>
                        <div class="card-subtitle"><i class="fas fa-phone"></i> ${c.telefone}</div>
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="App.cliente.edit('${c.id}')"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn-sm btn-whatsapp" onclick="App.whatsapp.openCliente('${c.id}')"><i class="fab fa-whatsapp"></i> Zap</button>
                        </div>
                    </div>
                `).join('');
            },

            renderOrcamentos: (filter = '') => {
                const list = document.getElementById('orcamentos-list');
                let filtered = UI.data.orcamentos.sort((a,b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));
                
                if(filter) {
                    filtered = filtered.filter(o => {
                        const c = UI.data.clientes.find(cl => cl.id === o.clienteId);
                        const cName = c ? c.nome.toLowerCase() : '';
                        return cName.includes(filter.toLowerCase()) || o.evento.toLowerCase().includes(filter.toLowerCase());
                    });
                }

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-file-invoice"></i><p>Nenhum orçamento.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(o => UI.createOrcamentoCard(o)).join('');
            },

            createOrcamentoCard: (o, isAlert = false) => {
                const c = UI.data.clientes.find(cl => cl.id === o.clienteId) || { nome: 'Desconhecido' };
                let statusTag = '';
                if(o.status === 'pendente') statusTag = `<span class="tag tag-pending">Pendente</span>`;
                if(o.status === 'aceito') statusTag = `<span class="tag tag-accepted">Fechado</span>`;
                if(o.status === 'recusado') statusTag = `<span class="tag tag-rejected">Recusado</span>`;
                if(isAlert) statusTag = `<span class="tag tag-alert">Vencido</span>`;

                return `
                    <div class="list-card" style="border-left-color: ${isAlert ? 'var(--danger)' : 'var(--primary)'}">
                        <div class="card-header">
                            <div class="card-title">#${o.numero} - ${c.nome}</div>
                            ${statusTag}
                        </div>
                        <div class="card-subtitle"><i class="fas fa-calendar-day"></i> ${Utils.formatDate(o.dataEvento)} • ${o.evento}</div>
                        <div class="card-price">${Utils.formatCurrency(o.valor)}</div>
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="App.orcamento.edit('${o.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-primary-soft" onclick="App.pdf.generate('${o.id}')"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn-sm btn-whatsapp" onclick="App.whatsapp.openOrcamento('${o.id}')"><i class="fab fa-whatsapp"></i> Enviar</button>
                            <button class="btn-sm btn-light" style="color:var(--danger)" onclick="App.orcamento.delete('${o.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            },

            renderFinanceiro: () => {
                const total = UI.data.orcamentos.reduce((acc, o) => acc + o.valor, 0);
                const aceito = UI.data.orcamentos.filter(o => o.status === 'aceito').reduce((acc, o) => acc + o.valor, 0);
                const pendente = UI.data.orcamentos.filter(o => o.status === 'pendente').reduce((acc, o) => acc + o.valor, 0);

                document.getElementById('fin-total').innerText = Utils.formatCurrency(total);
                document.getElementById('fin-aceito').innerText = Utils.formatCurrency(aceito);
                document.getElementById('fin-pendente').innerText = Utils.formatCurrency(pendente);
            },

            // --- MODALS ---
            openModal: (type) => {
                document.getElementById(`overlay-${type}`).classList.add('active');
                // Pequeno delay para animação suave
                requestAnimationFrame(() => {
                    document.getElementById(`overlay-${type}`).classList.add('active');
                });
            },
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },

            openNewCliente: (fromOrcamento = false) => {
                document.getElementById('form-cliente').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                document.getElementById('form-cliente').dataset.returnTo = fromOrcamento ? 'orcamento' : '';
                UI.openModal('cliente');
            },

            openNewOrcamento: () => {
                // Populate Cliente Select
                const select = document.getElementById('o-cliente');
                select.innerHTML = '<option value="">Selecione...</option>';
                UI.data.clientes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });

                if(UI.data.clientes.length === 0) {
                    Utils.toast('Cadastre um cliente primeiro!', 'error');
                    UI.openNewCliente(true);
                    return;
                }

                document.getElementById('form-orcamento').reset();
                document.getElementById('o-id').value = '';
                document.getElementById('title-orcamento').innerText = 'Novo Orçamento';
                
                // Defaults
                const sett = Storage.getSettings();
                const today = new Date();
                today.setDate(today.getDate() + 15); // Validade padrão 15 dias
                document.getElementById('o-validade').value = today.toISOString().split('T')[0];
                
                UI.openModal('orcamento');
            },

            openSettings: () => {
                const s = Storage.getSettings();
                document.getElementById('s-nome').value = s.nome;
                document.getElementById('s-telefone').value = s.telefone;
                document.getElementById('s-cidade').value = s.cidade;
                UI.openModal('settings');
            }
        };

        // --- APP LOGIC ---
        const App = {
            cliente: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;

                    const newClient = { id, nome, telefone, email };
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if(existingIdx >= 0) {
                        UI.data.clientes[existingIdx] = newClient;
                    } else {
                        UI.data.clientes.push(newClient);
                    }

                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Cliente salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    
                    if(document.getElementById('form-cliente').dataset.returnTo === 'orcamento') {
                        UI.openNewOrcamento();
                        // Selecionar o novo cliente
                        setTimeout(() => document.getElementById('o-cliente').value = id, 100);
                    } else {
                        UI.renderClientes();
                    }
                },
                edit: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-nome').value = c.nome;
                    document.getElementById('c-telefone').value = c.telefone;
                    document.getElementById('c-email').value = c.email;
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    UI.openModal('cliente');
                }
            },

            orcamento: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('o-id').value || Utils.id();
                    const settings = Storage.getSettings();
                    
                    const isNew = !document.getElementById('o-id').value;
                    let numero = '';
                    
                    if(isNew) {
                        numero = String(settings.nextOrcamento).padStart(4, '0');
                        settings.nextOrcamento++;
                        Storage.saveSettings(settings);
                    } else {
                        const existing = UI.data.orcamentos.find(o => o.id === id);
                        numero = existing.numero;
                    }

                    const orcamento = {
                        id,
                        numero,
                        clienteId: document.getElementById('o-cliente').value,
                        evento: document.getElementById('o-evento').value,
                        dataEvento: document.getElementById('o-data').value,
                        valor: Utils.parseCurrency(document.getElementById('o-valor').value),
                        status: document.getElementById('o-status').value,
                        validade: document.getElementById('o-validade').value,
                        descricao: document.getElementById('o-descricao').value,
                        dataCriacao: new Date().toISOString()
                    };

                    const idx = UI.data.orcamentos.findIndex(o => o.id === id);
                    if(idx >= 0) UI.data.orcamentos[idx] = orcamento;
                    else UI.data.orcamentos.push(orcamento);

                    Storage.set('orcamentos', UI.data.orcamentos);
                    Utils.toast('Orçamento salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderOrcamentos();
                },
                edit: (id) => {
                    const o = UI.data.orcamentos.find(x => x.id === id);
                    if(!o) return;
                    
                    // Populate select first
                    const select = document.getElementById('o-cliente');
                    select.innerHTML = '';
                    UI.data.clientes.forEach(c => {
                        select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                    });

                    document.getElementById('o-id').value = o.id;
                    document.getElementById('o-cliente').value = o.clienteId;
                    document.getElementById('o-evento').value = o.evento;
                    document.getElementById('o-data').value = o.dataEvento;
                    
                    const valInput = document.getElementById('o-valor');
                    valInput.value = (o.valor * 100).toFixed(0); // Hack para a máscara funcionar
                    Utils.maskMoney(valInput);
                    
                    document.getElementById('o-status').value = o.status;
                    document.getElementById('o-validade').value = o.validade;
                    document.getElementById('o-descricao').value = o.descricao;
                    
                    document.getElementById('title-orcamento').innerText = `Editar Orçamento #${o.numero}`;
                    UI.openModal('orcamento');
                },
                delete: (id) => {
                    if(confirm('Excluir este orçamento?')) {
                        UI.data.orcamentos = UI.data.orcamentos.filter(o => o.id !== id);
                        Storage.set('orcamentos', UI.data.orcamentos);
                        UI.renderDashboard();
                        UI.renderOrcamentos();
                        Utils.toast('Excluído!', 'success');
                    }
                }
            },

            settings: {
                save: (e) => {
                    e.preventDefault();
                    const s = Storage.getSettings();
                    s.nome = document.getElementById('s-nome').value;
                    s.telefone = document.getElementById('s-telefone').value;
                    s.cidade = document.getElementById('s-cidade').value;
                    Storage.saveSettings(s);
                    Utils.toast('Configurações salvas');
                    UI.closeModals();
                }
            },

            whatsapp: {
                openCliente: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    const num = c.telefone.replace(/\D/g, '');
                    window.open(`https://wa.me/55${num}`, '_blank');
                },
                openOrcamento: (id) => {
                    const o = UI.data.orcamentos.find(x => x.id === id);
                    const c = UI.data.clientes.find(x => x.id === o.clienteId);
                    const s = Storage.getSettings();
                    
                    const num = c.telefone.replace(/\D/g, '');
                    let msg = `Olá ${c.nome.split(' ')[0]}! Aqui é ${s.nome}.\n\n`;
                    msg += `Segue o orçamento *#${o.numero}* para seu evento (${o.evento}).\n`;
                    msg += `Data: ${Utils.formatDate(o.dataEvento)}\n`;
                    msg += `*Valor: ${Utils.formatCurrency(o.valor)}*\n\n`;
                    msg += `Qualquer dúvida estou à disposição!`;
                    
                    window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            },

            pdf: {
                generate: (id) => {
                    const o = UI.data.orcamentos.find(x => x.id === id);
                    const c = UI.data.clientes.find(x => x.id === o.clienteId);
                    const s = Storage.getSettings();
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Header Azul
                    doc.setFillColor(59, 130, 246);
                    doc.rect(0, 0, 210, 40, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text((s.nome || "ORÇAMENTO").toUpperCase(), 105, 20, { align: "center" });
                    doc.setFontSize(10);
                    doc.text("Proposta de Serviços", 105, 28, { align: "center" });

                    // Info
                    doc.setTextColor(0, 0, 0);
                    let y = 60;
                    
                    doc.setFontSize(11);
                    doc.text(`Orçamento: #${o.numero}`, 20, y);
                    doc.text(`Data Emissão: ${Utils.formatDate(new Date().toISOString().split('T')[0])}`, 140, y);
                    
                    y += 15;
                    doc.setDrawColor(200);
                    doc.line(20, y, 190, y);
                    y += 15;

                    doc.setFont("helvetica", "bold");
                    doc.text("DADOS DO CLIENTE", 20, y);
                    doc.setFont("helvetica", "normal");
                    y += 8;
                    doc.text(`Nome: ${c.nome}`, 20, y);
                    doc.text(`Telefone: ${c.telefone}`, 20, y+6);
                    
                    y += 20;
                    doc.setFont("helvetica", "bold");
                    doc.text("DETALHES DO EVENTO", 20, y);
                    doc.setFont("helvetica", "normal");
                    y += 8;
                    doc.text(`Tipo: ${o.evento}`, 20, y);
                    doc.text(`Data: ${Utils.formatDate(o.dataEvento)}`, 20, y+6);
                    doc.text(`Validade da Proposta: ${Utils.formatDate(o.validade)}`, 20, y+12);

                    y += 25;
                    doc.setFillColor(241, 245, 249);
                    doc.rect(20, y-5, 170, 20 + (o.descricao.length / 2), 'F');
                    doc.setFont("helvetica", "bold");
                    doc.text("DESCRIÇÃO / PACOTE", 25, y+2);
                    doc.setFont("helvetica", "normal");
                    
                    const splitDesc = doc.splitTextToSize(o.descricao || "Serviços de DJ conforme combinado.", 160);
                    doc.text(splitDesc, 25, y+10);
                    
                    y += 40 + (splitDesc.length * 5);

                    // Total
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(59, 130, 246);
                    doc.text(`TOTAL: ${Utils.formatCurrency(o.valor)}`, 190, y, { align: "right" });

                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(`Documento gerado digitalmente por DJ Manager Mobile`, 105, 280, { align: "center" });

                    doc.save(`Orcamento_${o.numero}.pdf`);
                    Utils.toast('PDF Baixado!');
                }
            },

            backup: {
                exportData: () => {
                    const data = {
                        clientes: UI.data.clientes,
                        orcamentos: UI.data.orcamentos,
                        settings: Storage.getSettings()
                    };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_dj_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                },
                importTrigger: () => document.getElementById('import-file').click(),
                importData: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.clientes) Storage.set('clientes', data.clientes);
                            if(data.orcamentos) Storage.set('orcamentos', data.orcamentos);
                            if(data.settings) Storage.saveSettings(data.settings);
                            location.reload();
                        } catch(err) {
                            Utils.toast('Erro no arquivo', 'error');
                        }
                    };
                    reader.readAsText(file);
                },
                clearData: () => {
                    if(confirm('Tem certeza? Isso apagará TUDO!')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            }
        };

        // --- CLOSING MODALS ON OUTSIDE CLICK ---
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if(e.target === overlay) UI.closeModals();
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', UI.init);

    </script>
</body>
</html>
