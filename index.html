<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DJ Manager Pro - Alek Ed.</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Cores Modernas Palette */
            --primary: #3b82f6; /* Azul vibrante */
            --primary-dark: #1d4ed8;
            --secondary: #64748b; /* Slate */
            --accent: #8b5cf6; /* Roxo */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            
            /* Dimensões e Espaçamentos */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: calc(60px + var(--safe-top));
            --nav-height: calc(65px + var(--safe-bottom));
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-float: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: var(--dark);
            height: 100vh;
            overflow: hidden; /* App-like feel */
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: var(--safe-top) 16px 10px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--dark);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand span { color: var(--primary); }
        
        .header-actions { display: flex; gap: 12px; }
        .icon-btn {
            background: none; border: none; font-size: 1.2rem;
            color: var(--secondary); padding: 8px;
            border-radius: 50%; transition: 0.2s;
        }
        .icon-btn:active { background: #f1f5f9; color: var(--primary); transform: scale(0.95); }

        /* --- Main Content Area --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 16px) 16px calc(var(--nav-height) + 80px); /* Extra padding bottom for FAB */
            scroll-behavior: smooth;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:active { transform: scale(0.98); box-shadow: var(--shadow-sm); }

        .stat-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem;
        }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--dark); line-height: 1; }
        .stat-label { font-size: 0.8rem; color: var(--secondary); font-weight: 500; }

        /* Chart Container */
        .chart-container {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            height: 300px;
            position: relative;
        }

        /* Colors for Stats */
        .bg-blue { background: #dbeafe; color: var(--primary); }
        .bg-green { background: #d1fae5; color: var(--success); }
        .bg-orange { background: #ffedd5; color: var(--warning); }
        .bg-red { background: #fee2e2; color: var(--danger); }

        /* --- Lists & items --- */
        .section-title {
            font-size: 1.1rem; font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .search-container {
            position: relative; margin-bottom: 16px;
        }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); font-size: 1rem; outline: none;
            -webkit-appearance: none;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--secondary);
        }

        /* List Card - Melhorado para clicar */
        .list-card {
            background: var(--surface);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border-left: 4px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .list-card:active { transform: scale(0.98); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .card-subtitle { font-size: 0.85rem; color: var(--secondary); display: flex; gap: 6px; align-items: center; }
        
        .tag {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 99px;
            font-weight: 600; text-transform: uppercase;
        }
        .tag-pending { background: #fff7ed; color: #c2410c; }
        .tag-accepted { background: #ecfdf5; color: #047857; }
        .tag-rejected { background: #fef2f2; color: #b91c1c; }
        .tag-alert { background: #fee2e2; color: #ef4444; animation: pulse 2s infinite; }

        .card-price { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin-top: 8px; }

        .action-row {
            display: flex; gap: 8px; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid #f1f5f9;
        }
        .btn-sm {
            flex: 1; padding: 8px; border-radius: 8px;
            border: none; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            cursor: pointer;
        }
        .btn-light { background: #f1f5f9; color: var(--secondary); }
        .btn-primary-soft { background: #dbeafe; color: var(--primary); }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 50;
        }

        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: #94a3b8; text-decoration: none;
            font-size: 0.7rem; font-weight: 500;
            gap: 4px; transition: 0.2s;
        }
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* --- Floating Action Button (FAB) --- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 16px);
            right: 16px;
            width: 56px; height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-float);
            z-index: 40;
            border: none;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        /* --- Modals / Sheets --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-radius: 20px 20px 0 0;
            padding: 24px 16px calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh;
            overflow-y: auto;
            z-index: 101;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active + .modal-sheet { transform: translateY(0); }

        .sheet-handle {
            width: 40px; height: 4px; background: #cbd5e1;
            border-radius: 2px; margin: 0 auto 20px;
        }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; color: var(--dark); }
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            -webkit-appearance: none;
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }
        textarea.form-control { min-height: 100px; resize: none; }

        .btn-block {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            background: var(--primary); color: white;
            margin-top: 10px;
        }

        /* --- Card de Detalhes do Orçamento --- */
        .details-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .details-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--dark);
        }
        
        .details-subtitle {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        .details-section {
            margin-bottom: 20px;
        }
        
        .details-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .details-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: var(--secondary);
            font-weight: 500;
        }
        
        .info-value {
            font-size: 1rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        .private-notes {
            background: #fff7ed;
            border-left: 4px solid var(--warning);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }
        
        .private-notes-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: #c2410c;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .private-notes-content {
            font-size: 0.9rem;
            color: #7c2d12;
            line-height: 1.4;
        }
        
        .details-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .btn-details {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-details:active { transform: scale(0.95); }
        
        .btn-details-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-details-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-details-secondary {
            background: var(--light);
            color: var(--secondary);
        }
        
        .btn-details-danger {
            background: var(--light);
            color: var(--danger);
        }

        /* Imagem Preview no Settings */
        .logo-preview-container {
            width: 100%; display: flex; justify-content: center; margin-bottom: 15px;
        }
        .logo-preview {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 2px dashed var(--border); background: var(--light);
        }
        
        /* Utility */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        .toast {
            position: fixed; top: var(--header-height); left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--dark); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 500;
            box-shadow: var(--shadow-float);
            z-index: 200;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(20px); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        /* Badge para notificações */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .badge-primary { background: var(--primary); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        
        /* Data e hora formatadas */
        .date-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--light);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--secondary);
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fas fa-compact-disc" style="color: var(--primary);"></i>
            DJ<span>Manager</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" onclick="App.backup.exportData()"><i class="fas fa-cloud-download-alt"></i></button>
            <button class="icon-btn" onclick="UI.openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> <span>Ação realizada!</span>
    </div>

    <main>
        <div id="dashboard-view" class="view active">
            <div class="section-title">Visão Geral</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="UI.navigate('orcamentos')">
                    <div class="stat-icon bg-blue"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="stat-value" id="dash-total-orcamentos">0</div>
                    <div class="stat-label">Orçamentos</div>
                </div>
                <div class="stat-card" onclick="UI.navigate('clientes')">
                    <div class="stat-icon bg-green"><i class="fas fa-users"></i></div>
                    <div class="stat-value" id="dash-total-clientes">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="dash-pendentes">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-red"><i class="fas fa-bell"></i></div>
                    <div class="stat-value" id="dash-followup">0</div>
                    <div class="stat-label">Follow-up</div>
                </div>
            </div>

            <div class="section-title">
                Atenção Necessária
                <span class="tag tag-alert" id="alert-badge" style="display:none">!</span>
            </div>
            <div id="followup-list">
                <!-- Lista de follow-ups será preenchida aqui -->
            </div>
        </div>

        <div id="clientes-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar clientes..." oninput="UI.renderClientes(this.value)">
            </div>
            <div id="clientes-list"></div>
        </div>

        <div id="orcamentos-view" class="view">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Buscar orçamentos..." oninput="UI.renderOrcamentos(this.value)">
            </div>
            <div id="orcamentos-list"></div>
        </div>

        <div id="financeiro-view" class="view">
            <div class="section-title">Previsão Mensal (Confirmado + Pendente)</div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>

            <div class="section-title">Resumo Geral</div>
            <div class="list-card">
                <div class="card-subtitle">Potencial Total (Estimado)</div>
                <div class="card-price" id="fin-total">R$ 0,00</div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-check"></i></div>
                    <div class="stat-value" id="fin-aceito" style="font-size: 1.1rem">R$ 0</div>
                    <div class="stat-label">Já Fechado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange"><i class="fas fa-hourglass-half"></i></div>
                    <div class="stat-value" id="fin-pendente" style="font-size: 1.1rem">R$ 0</div>
                    <div class="stat-label">A Fechar</div>
                </div>
            </div>
        </div>
    </main>

    <button class="fab" onclick="UI.openNewOrcamento()" id="main-fab">
        <i class="fas fa-plus"></i>
    </button>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="dashboard-view" onclick="UI.switchTab(this)">
            <i class="fas fa-home"></i> <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-target="clientes-view" onclick="UI.switchTab(this)">
            <i class="fas fa-user-friends"></i> <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-target="orcamentos-view" onclick="UI.switchTab(this)">
            <i class="fas fa-file-invoice"></i> <span>Orç.</span>
        </a>
        <a href="#" class="nav-item" data-target="financeiro-view" onclick="UI.switchTab(this)">
            <i class="fas fa-chart-pie"></i> <span>Finanças</span>
        </a>
    </nav>

    <!-- Modal de Detalhes do Orçamento -->
    <div class="modal-overlay" id="overlay-orcamento-details"></div>
    <div class="modal-sheet" id="sheet-orcamento-details">
        <div class="sheet-handle"></div>
        <div id="orcamento-details-content">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <div class="modal-overlay" id="overlay-cliente"></div>
    <div class="modal-sheet" id="sheet-cliente">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-cliente">Novo Cliente</h3>
        <form id="form-cliente" onsubmit="App.cliente.save(event)">
            <input type="hidden" id="c-id">
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" id="c-nome" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Telefone (WhatsApp)</label>
                <input type="tel" id="c-telefone" class="form-control" placeholder="(00) 00000-0000" required oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email (Opcional)</label>
                <input type="email" id="c-email" class="form-control">
            </div>
            <button type="submit" class="btn-block">Salvar Cliente</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <div class="modal-overlay" id="overlay-orcamento"></div>
    <div class="modal-sheet" id="sheet-orcamento">
        <div class="sheet-handle"></div>
        <h3 class="section-title" id="title-orcamento">Novo Orçamento</h3>
        <form id="form-orcamento" onsubmit="App.orcamento.save(event)">
            <input type="hidden" id="o-id">
            
            <div class="form-group">
                <label class="form-label">Cliente</label>
                <div style="display: flex; gap: 8px;">
                    <select id="o-cliente" class="form-control" required style="flex: 1"></select>
                    <button type="button" onclick="UI.openNewCliente(true)" class="icon-btn" style="background: var(--primary); color: white; border-radius: 8px;"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="form-group" style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                    <label class="form-label">Tipo Evento</label>
                    <select id="o-evento" class="form-control">
                        <option value="Infantil">Infantil</option>
                        <option value="Aniversário">Aniversário</option>
                        <option value="15 Anos">15 Anos</option>
                        <option value="Casamento">Casamento</option>
                        <option value="Corporativo">Corporativo</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label class="form-label">Data Evento</label>
                    <input type="date" id="o-data" class="form-control" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Horário (Início - Fim)</label>
                <input type="text" id="o-horario" class="form-control" placeholder="Ex: 18:00 - 22:00">
            </div>

            <div class="form-group">
                <label class="form-label">Local do Evento</label>
                <input type="text" id="o-local" class="form-control" placeholder="Ex: Salão de Festas X">
            </div>

            <div class="form-group">
                <label class="form-label">Valor (R$)</label>
                <input type="text" inputmode="numeric" id="o-valor" class="form-control" placeholder="0,00" required oninput="Utils.maskMoney(this)">
            </div>

            <div class="form-group">
                <label class="form-label">Status</label>
                <select id="o-status" class="form-control">
                    <option value="pendente">Pendente</option>
                    <option value="aceito">Aceito (Fechado)</option>
                    <option value="recusado">Recusado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Validade Orçamento</label>
                <input type="date" id="o-validade" class="form-control">
            </div>

            <div class="form-group">
                <label class="form-label">Descrição / Serviços (Público)</label>
                <textarea id="o-descricao" class="form-control" placeholder="Dj, som, iluminação..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" style="color: var(--warning);"><i class="fas fa-eye-slash"></i> Observações Internas (Não sai no PDF)</label>
                <textarea id="o-obs-internas" class="form-control" placeholder="Anotações privadas sobre o cliente ou negociação..." style="background: #fffbeb; border-color: #fcd34d;"></textarea>
            </div>

            <button type="submit" class="btn-block">Salvar Orçamento</button>
            <button type="button" class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Cancelar</button>
        </form>
    </div>

    <div class="modal-overlay" id="overlay-settings"></div>
    <div class="modal-sheet" id="sheet-settings">
        <div class="sheet-handle"></div>
        <h3 class="section-title">Configurações & Logo</h3>
        <form id="form-settings" onsubmit="App.settings.save(event)">
            
            <div class="logo-preview-container">
                <img id="s-logo-preview" class="logo-preview" src="" style="display:none">
                <div id="s-logo-placeholder" class="logo-preview" style="display:flex; align-items:center; justify-content:center; color:var(--secondary);"><i class="fas fa-image"></i></div>
            </div>
            <div class="form-group" style="text-align: center;">
                <label for="s-logo-input" style="color: var(--primary); font-weight: 600; cursor: pointer;">
                    <i class="fas fa-upload"></i> Carregar Logomarca
                </label>
                <input type="file" id="s-logo-input" accept="image/*" style="display: none;" onchange="App.settings.previewLogo(this)">
                <input type="hidden" id="s-logo-data">
            </div>

            <div class="form-group">
                <label class="form-label">Nome Artístico / Empresa</label>
                <input type="text" id="s-nome" class="form-control" placeholder="Dj Alek Musica & Arte">
            </div>
            <div class="form-group">
                <label class="form-label">Nome Completo (Razão Social)</label>
                <input type="text" id="s-razao" class="form-control" placeholder="Jose Alex...">
            </div>
            <div class="form-group">
                <label class="form-label">CNPJ</label>
                <input type="text" id="s-cnpj" class="form-control" placeholder="XX.XXX.XXX/0001-XX">
            </div>
            <div class="form-group">
                <label class="form-label">Telefone Contato</label>
                <input type="tel" id="s-telefone" class="form-control" oninput="Utils.maskPhone(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="s-email" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Instagram (@)</label>
                <input type="text" id="s-instagram" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Endereço Completo</label>
                <textarea id="s-endereco" class="form-control" placeholder="Rua, Bairro, CEP..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Chave PIX</label>
                <input type="text" id="s-pix" class="form-control">
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 16px 0;">
            <button type="button" class="btn-block" style="background: var(--danger);" onclick="App.backup.clearData()">
                <i class="fas fa-trash"></i> Resetar Tudo
            </button>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn-block" style="background: var(--secondary); margin: 0;" onclick="App.backup.importTrigger()">Importar Backup</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="App.backup.importData(this)">
                <button type="submit" class="btn-block" style="background: var(--primary); margin: 0;">Salvar</button>
            </div>
        </form>
    </div>

    <script>
        // --- UTILITÁRIOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatCurrency: (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            parseCurrency: (str) => parseFloat(str.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0,
            formatDate: (dateStr) => {
                if(!dateStr) return '-';
                const [y, m, d] = dateStr.split('-');
                return `${d}/${m}/${y}`;
            },
            formatDateTime: (dateStr) => {
                if(!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            },
            maskPhone: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = v.replace(/^(\d{2})(\d)/g, "($1) $2");
                v = v.replace(/(\d)(\d{4})$/, "$1-$2");
                input.value = v.substring(0, 15);
            },
            maskMoney: (input) => {
                let v = input.value.replace(/\D/g, "");
                v = (v / 100).toFixed(2) + "";
                v = v.replace(".", ",");
                v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
                input.value = v;
            },
            toast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> <span>${msg}</span>`;
                t.style.background = type === 'success' ? 'var(--dark)' : 'var(--danger)';
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            readImage: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        };

        // --- STORAGE MANAGER ---
        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(`djapp_${key}`)) || [],
            set: (key, data) => localStorage.setItem(`djapp_${key}`, JSON.stringify(data)),
            getSettings: () => JSON.parse(localStorage.getItem('djapp_settings')) || { 
                nome: 'Dj Alek Musica & Arte',
                razao: 'JOSE ALEX PEIXOTO DE ASSIS',
                telefone: '+55 (82) 99627-0122',
                email: 'djalekoficial@gmail.com',
                instagram: '@djalekoficial',
                cnpj: '31.632.000/0001-38',
                endereco: 'Rua Ernandes de Barros, 352\nSanta Lúcia, Maceió-AL\nCEP 57082-132',
                pix: '31632000000138',
                nextOrcamento: 27,
                logo: null,
                clausulasContrato: `1. O presente orçamento tem validade de 15 dias a partir da data de emissão.
2. Para reserva da data, será necessário o pagamento de 50% do valor total como sinal.
3. O pagamento do saldo restante deverá ser efetuado até o dia do evento.
4. Em caso de cancelamento pelo contratante com menos de 30 dias do evento, o sinal não será devolvido.
5. O profissional se compromete a chegar ao local do evento com 2 horas de antecedência para montagem e testes.
6. O horário de término do serviço será conforme acordado, com tolerância máxima de 30 minutos.
7. O contratante é responsável por fornecer ponto de energia adequado e seguro.
8. Em caso de eventos em locais abertos, é necessária proteção contra chuva para o equipamento.
9. O repertório será definido em conjunto com o contratante, respeitando a classificação indicativa.
10. O som e iluminação serão ajustados conforme as normas do local e legislação vigente.`
            },
            saveSettings: (data) => localStorage.setItem('djapp_settings', JSON.stringify(data))
        };

        // --- UI MANAGER ---
        const UI = {
            data: { clientes: [], orcamentos: [] },
            chartInstance: null,
            
            init: () => {
                UI.data.clientes = Storage.get('clientes');
                UI.data.orcamentos = Storage.get('orcamentos');
                UI.renderDashboard();
                
                // Tabs listeners
                document.querySelectorAll('.bottom-nav .nav-item').forEach(el => {
                    el.addEventListener('click', (e) => e.preventDefault());
                });
            },

            switchTab: (el) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                el.classList.add('active');
                const target = el.getAttribute('data-target');
                document.getElementById(target).classList.add('active');

                // Toggle FAB visibility
                const fab = document.getElementById('main-fab');
                if(target === 'dashboard-view' || target === 'orcamentos-view') {
                    fab.style.display = 'flex';
                    fab.onclick = UI.openNewOrcamento;
                } else if (target === 'clientes-view') {
                    fab.style.display = 'flex';
                    fab.onclick = () => UI.openNewCliente(false);
                } else {
                    fab.style.display = 'none';
                }

                if(target === 'clientes-view') UI.renderClientes();
                if(target === 'orcamentos-view') UI.renderOrcamentos();
                if(target === 'financeiro-view') UI.renderFinanceiro();
            },

            navigate: (tabName) => {
                const el = document.querySelector(`.nav-item[data-target="${tabName}-view"]`);
                if(el) UI.switchTab(el);
            },

            // --- RENDER FUNCTIONS ---
            renderDashboard: () => {
                const { clientes, orcamentos } = UI.data;
                document.getElementById('dash-total-clientes').innerText = clientes.length;
                document.getElementById('dash-total-orcamentos').innerText = orcamentos.length;
                document.getElementById('dash-pendentes').innerText = orcamentos.filter(o => o.status === 'pendente').length;
                
                // Follow up logic
                const today = new Date().toISOString().split('T')[0];
                const followups = orcamentos.filter(o => 
                    o.status === 'pendente' && (o.validade < today || o.validade === today)
                );
                
                document.getElementById('dash-followup').innerText = followups.length;
                document.getElementById('alert-badge').style.display = followups.length > 0 ? 'inline-block' : 'none';

                const list = document.getElementById('followup-list');
                if(followups.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-thumbs-up"></i><p>Tudo em dia!</p></div>`;
                } else {
                    list.innerHTML = followups.map(o => UI.createOrcamentoCard(o, true)).join('');
                }
            },

            renderClientes: (filter = '') => {
                const list = document.getElementById('clientes-list');
                const filtered = UI.data.clientes.filter(c => c.nome.toLowerCase().includes(filter.toLowerCase()));
                
                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-user-plus"></i><p>Nenhum cliente encontrado.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(c => `
                    <div class="list-card">
                        <div class="card-header">
                            <div class="card-title">${c.nome}</div>
                        </div>
                        <div class="card-subtitle"><i class="fas fa-phone"></i> ${c.telefone}</div>
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="App.cliente.edit('${c.id}')"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn-sm btn-whatsapp" onclick="App.whatsapp.openCliente('${c.id}')"><i class="fab fa-whatsapp"></i> Zap</button>
                        </div>
                    </div>
                `).join('');
            },

            renderOrcamentos: (filter = '') => {
                const list = document.getElementById('orcamentos-list');
                let filtered = UI.data.orcamentos.sort((a,b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));
                
                if(filter) {
                    filtered = filtered.filter(o => {
                        const c = UI.data.clientes.find(cl => cl.id === o.clienteId);
                        const cName = c ? c.nome.toLowerCase() : '';
                        return cName.includes(filter.toLowerCase()) || o.evento.toLowerCase().includes(filter.toLowerCase());
                    });
                }

                if(filtered.length === 0) {
                    list.innerHTML = `<div class="empty-state"><i class="fas fa-file-invoice"></i><p>Nenhum orçamento.</p></div>`;
                    return;
                }

                list.innerHTML = filtered.map(o => UI.createOrcamentoCard(o)).join('');
            },

            createOrcamentoCard: (o, isAlert = false) => {
                const c = UI.data.clientes.find(cl => cl.id === o.clienteId) || { nome: 'Desconhecido' };
                let statusTag = '';
                if(o.status === 'pendente') statusTag = `<span class="tag tag-pending">Pendente</span>`;
                if(o.status === 'aceito') statusTag = `<span class="tag tag-accepted">Fechado</span>`;
                if(o.status === 'recusado') statusTag = `<span class="tag tag-rejected">Recusado</span>`;
                if(isAlert) statusTag = `<span class="tag tag-alert">Vencido</span>`;

                return `
                    <div class="list-card" style="border-left-color: ${isAlert ? 'var(--danger)' : 'var(--primary)'}" onclick="UI.showOrcamentoDetails('${o.id}')">
                        <div class="card-header">
                            <div class="card-title">#${o.numero} - ${c.nome}</div>
                            ${statusTag}
                        </div>
                        <div class="card-subtitle"><i class="fas fa-calendar-day"></i> ${Utils.formatDate(o.dataEvento)} • ${o.evento}</div>
                        <div class="card-price">${Utils.formatCurrency(o.valor)}</div>
                        <div class="action-row">
                            <button class="btn-sm btn-light" onclick="event.stopPropagation(); App.orcamento.edit('${o.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-primary-soft" onclick="event.stopPropagation(); App.pdf.generate('${o.id}')"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button class="btn-sm btn-whatsapp" onclick="event.stopPropagation(); App.whatsapp.openOrcamento('${o.id}')"><i class="fab fa-whatsapp"></i> Enviar</button>
                            <button class="btn-sm btn-light" style="color:var(--danger)" onclick="event.stopPropagation(); App.orcamento.delete('${o.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            },

            // Nova função para exibir detalhes do orçamento
            showOrcamentoDetails: (id) => {
                const o = UI.data.orcamentos.find(x => x.id === id);
                if(!o) return;
                
                const c = UI.data.clientes.find(cl => cl.id === o.clienteId) || { nome: 'Desconhecido', telefone: '', email: '' };
                const settings = Storage.getSettings();
                
                let statusBadge = '';
                if(o.status === 'pendente') statusBadge = `<span class="badge badge-warning">PENDENTE</span>`;
                if(o.status === 'aceito') statusBadge = `<span class="badge badge-primary">FECHADO</span>`;
                if(o.status === 'recusado') statusBadge = `<span class="badge badge-danger">RECUSADO</span>`;
                
                const detailsContent = `
                    <div class="details-card">
                        <div class="details-header">
                            <div>
                                <div class="details-title">Orçamento #${o.numero}</div>
                                <div class="details-subtitle">Criado em: ${Utils.formatDateTime(o.dataCriacao)}</div>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-user"></i> CLIENTE</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Nome</div>
                                    <div class="info-value">${c.nome}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Telefone</div>
                                    <div class="info-value">${c.telefone}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${c.email || '-'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-calendar-alt"></i> EVENTO</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Tipo</div>
                                    <div class="info-value">${o.evento}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Data</div>
                                    <div class="info-value">${Utils.formatDate(o.dataEvento)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Horário</div>
                                    <div class="info-value">${o.horario || '-'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Local</div>
                                    <div class="info-value">${o.local || '-'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-money-bill-wave"></i> FINANCEIRO</div>
                            <div class="details-info-grid">
                                <div class="info-item">
                                    <div class="info-label">Valor Total</div>
                                    <div class="info-value" style="color: var(--primary); font-size: 1.2rem;">${Utils.formatCurrency(o.valor)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value">${o.status === 'pendente' ? 'Pendente' : o.status === 'aceito' ? 'Aceito' : 'Recusado'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Validade</div>
                                    <div class="info-value">${Utils.formatDate(o.validade)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <div class="details-section-title"><i class="fas fa-clipboard-list"></i> SERVIÇOS INCLUÍDOS</div>
                            <div class="info-item">
                                <div class="info-label">Descrição</div>
                                <div class="info-value">${o.descricao || 'Serviços de DJ, som e iluminação'}</div>
                            </div>
                        </div>
                        
                        ${o.obsInternas ? `
                        <div class="private-notes">
                            <div class="private-notes-label"><i class="fas fa-eye-slash"></i> OBSERVAÇÕES INTERNAS</div>
                            <div class="private-notes-content">${o.obsInternas}</div>
                        </div>
                        ` : ''}
                        
                        <div class="details-actions">
                            <button class="btn-details btn-details-primary" onclick="App.orcamento.edit('${o.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-details btn-details-whatsapp" onclick="App.whatsapp.openOrcamento('${o.id}')">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
                            <button class="btn-details btn-details-secondary" onclick="App.pdf.generate('${o.id}')">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                    <button class="btn-block" style="background: var(--light); color: var(--secondary); margin-top: 8px;" onclick="UI.closeModals()">Fechar</button>
                `;
                
                document.getElementById('orcamento-details-content').innerHTML = detailsContent;
                UI.openModal('orcamento-details');
            },

            renderFinanceiro: () => {
                const total = UI.data.orcamentos.reduce((acc, o) => acc + o.valor, 0);
                const aceito = UI.data.orcamentos.filter(o => o.status === 'aceito').reduce((acc, o) => acc + o.valor, 0);
                const pendente = UI.data.orcamentos.filter(o => o.status === 'pendente').reduce((acc, o) => acc + o.valor, 0);

                document.getElementById('fin-total').innerText = Utils.formatCurrency(total);
                document.getElementById('fin-aceito').innerText = Utils.formatCurrency(aceito);
                document.getElementById('fin-pendente').innerText = Utils.formatCurrency(pendente);
                
                UI.renderChart();
            },

            renderChart: () => {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                // Agrupar dados: Fechados e Pendentes
                const confirmedData = {};
                const pendingData = {};
                
                UI.data.orcamentos.forEach(o => {
                    if (!o.dataEvento || o.status === 'recusado') return;
                    
                    const dateKey = o.dataEvento.substring(0, 7); // YYYY-MM
                    
                    if(o.status === 'aceito') {
                        confirmedData[dateKey] = (confirmedData[dateKey] || 0) + o.valor;
                    } else if (o.status === 'pendente') {
                        pendingData[dateKey] = (pendingData[dateKey] || 0) + o.valor;
                    }
                });

                // Obter todas as chaves únicas (meses)
                const allKeys = new Set([...Object.keys(confirmedData), ...Object.keys(pendingData)]);
                const sortedKeys = Array.from(allKeys).sort();

                const labels = sortedKeys.map(k => {
                    const [y, m] = k.split('-');
                    return `${m}/${y}`;
                });
                
                const dataConfirmed = sortedKeys.map(k => confirmedData[k] || 0);
                const dataPending = sortedKeys.map(k => pendingData[k] || 0);

                if (UI.chartInstance) {
                    UI.chartInstance.destroy();
                }

                if (sortedKeys.length === 0) return;

                UI.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Fechado',
                                data: dataConfirmed,
                                backgroundColor: '#3b82f6', // Primary Blue
                                borderRadius: 4,
                                stack: 'Stack 0',
                            },
                            {
                                label: 'Pendente (Previsto)',
                                data: dataPending,
                                backgroundColor: '#f59e0b', // Warning Orange
                                borderRadius: 4,
                                stack: 'Stack 0',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'bottom',
                                labels: { boxWidth: 12, font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            label += Utils.formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                grid: { borderDash: [2, 4], color: '#e2e8f0' },
                                ticks: {
                                    callback: function(value) {
                                        if(value >= 1000) return 'R$ ' + value / 1000 + 'k';
                                        return value;
                                    },
                                    font: { size: 10 }
                                }
                            },
                            x: {
                                stacked: true,
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            }
                        }
                    }
                });
            },

            // --- MODALS ---
            openModal: (type) => {
                document.getElementById(`overlay-${type}`).classList.add('active');
                requestAnimationFrame(() => {
                    document.getElementById(`overlay-${type}`).classList.add('active');
                });
            },
            closeModals: () => {
                document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            },

            openNewCliente: (fromOrcamento = false) => {
                document.getElementById('form-cliente').reset();
                document.getElementById('c-id').value = '';
                document.getElementById('title-cliente').innerText = 'Novo Cliente';
                document.getElementById('form-cliente').dataset.returnTo = fromOrcamento ? 'orcamento' : '';
                UI.openModal('cliente');
            },

            openNewOrcamento: () => {
                const select = document.getElementById('o-cliente');
                select.innerHTML = '<option value="">Selecione...</option>';
                UI.data.clientes.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });

                if(UI.data.clientes.length === 0) {
                    Utils.toast('Cadastre um cliente primeiro!', 'error');
                    UI.openNewCliente(true);
                    return;
                }

                document.getElementById('form-orcamento').reset();
                document.getElementById('o-id').value = '';
                document.getElementById('title-orcamento').innerText = 'Novo Orçamento';
                
                const sett = Storage.getSettings();
                const today = new Date();
                today.setDate(today.getDate() + 15);
                document.getElementById('o-validade').value = today.toISOString().split('T')[0];
                
                UI.openModal('orcamento');
            },

            openSettings: () => {
                const s = Storage.getSettings();
                document.getElementById('s-nome').value = s.nome || '';
                document.getElementById('s-razao').value = s.razao || '';
                document.getElementById('s-cnpj').value = s.cnpj || '';
                document.getElementById('s-telefone').value = s.telefone || '';
                document.getElementById('s-email').value = s.email || '';
                document.getElementById('s-instagram').value = s.instagram || '';
                document.getElementById('s-endereco').value = s.endereco || '';
                document.getElementById('s-pix').value = s.pix || '';
                
                // Logo Handling
                document.getElementById('s-logo-data').value = s.logo || '';
                if(s.logo) {
                    document.getElementById('s-logo-preview').src = s.logo;
                    document.getElementById('s-logo-preview').style.display = 'block';
                    document.getElementById('s-logo-placeholder').style.display = 'none';
                } else {
                    document.getElementById('s-logo-preview').style.display = 'none';
                    document.getElementById('s-logo-placeholder').style.display = 'flex';
                }
                
                UI.openModal('settings');
            }
        };

        // --- APP LOGIC ---
        const App = {
            cliente: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('c-id').value || Utils.id();
                    const nome = document.getElementById('c-nome').value;
                    const telefone = document.getElementById('c-telefone').value;
                    const email = document.getElementById('c-email').value;

                    const newClient = { id, nome, telefone, email };
                    
                    const existingIdx = UI.data.clientes.findIndex(c => c.id === id);
                    if(existingIdx >= 0) {
                        UI.data.clientes[existingIdx] = newClient;
                    } else {
                        UI.data.clientes.push(newClient);
                    }

                    Storage.set('clientes', UI.data.clientes);
                    Utils.toast('Cliente salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    
                    if(document.getElementById('form-cliente').dataset.returnTo === 'orcamento') {
                        UI.openNewOrcamento();
                        setTimeout(() => document.getElementById('o-cliente').value = id, 100);
                    } else {
                        UI.renderClientes();
                    }
                },
                edit: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    document.getElementById('c-id').value = c.id;
                    document.getElementById('c-nome').value = c.nome;
                    document.getElementById('c-telefone').value = c.telefone;
                    document.getElementById('c-email').value = c.email;
                    document.getElementById('title-cliente').innerText = 'Editar Cliente';
                    UI.openModal('cliente');
                }
            },

            orcamento: {
                save: (e) => {
                    e.preventDefault();
                    const id = document.getElementById('o-id').value || Utils.id();
                    const settings = Storage.getSettings();
                    
                    const isNew = !document.getElementById('o-id').value;
                    let numero = '';
                    
                    if(isNew) {
                        numero = String(settings.nextOrcamento).padStart(3, '0') + '-' + new Date().getFullYear();
                        settings.nextOrcamento++;
                        Storage.saveSettings(settings);
                    } else {
                        const existing = UI.data.orcamentos.find(o => o.id === id);
                        numero = existing.numero;
                    }

                    const orcamento = {
                        id,
                        numero,
                        clienteId: document.getElementById('o-cliente').value,
                        evento: document.getElementById('o-evento').value,
                        dataEvento: document.getElementById('o-data').value,
                        local: document.getElementById('o-local').value,
                        horario: document.getElementById('o-horario').value,
                        valor: Utils.parseCurrency(document.getElementById('o-valor').value),
                        status: document.getElementById('o-status').value,
                        validade: document.getElementById('o-validade').value,
                        descricao: document.getElementById('o-descricao').value,
                        obsInternas: document.getElementById('o-obs-internas').value,
                        dataCriacao: new Date().toISOString()
                    };

                    const idx = UI.data.orcamentos.findIndex(o => o.id === id);
                    if(idx >= 0) UI.data.orcamentos[idx] = orcamento;
                    else UI.data.orcamentos.push(orcamento);

                    Storage.set('orcamentos', UI.data.orcamentos);
                    Utils.toast('Orçamento salvo!');
                    UI.closeModals();
                    UI.renderDashboard();
                    UI.renderOrcamentos();
                },
                edit: (id) => {
                    const o = UI.data.orcamentos.find(x => x.id === id);
                    if(!o) return;
                    
                    const select = document.getElementById('o-cliente');
                    select.innerHTML = '';
                    UI.data.clientes.forEach(c => {
                        select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                    });

                    document.getElementById('o-id').value = o.id;
                    document.getElementById('o-cliente').value = o.clienteId;
                    document.getElementById('o-evento').value = o.evento;
                    document.getElementById('o-data').value = o.dataEvento;
                    document.getElementById('o-local').value = o.local || '';
                    document.getElementById('o-horario').value = o.horario || '';
                    
                    const valInput = document.getElementById('o-valor');
                    valInput.value = (o.valor * 100).toFixed(0);
                    Utils.maskMoney(valInput);
                    
                    document.getElementById('o-status').value = o.status;
                    document.getElementById('o-validade').value = o.validade;
                    document.getElementById('o-descricao').value = o.descricao;
                    document.getElementById('o-obs-internas').value = o.obsInternas || '';
                    
                    document.getElementById('title-orcamento').innerText = `Editar Orçamento #${o.numero}`;
                    UI.openModal('orcamento');
                },
                delete: (id) => {
                    if(confirm('Excluir este orçamento?')) {
                        UI.data.orcamentos = UI.data.orcamentos.filter(o => o.id !== id);
                        Storage.set('orcamentos', UI.data.orcamentos);
                        UI.renderDashboard();
                        UI.renderOrcamentos();
                        Utils.toast('Excluído!', 'success');
                    }
                }
            },

            settings: {
                previewLogo: async (input) => {
                    if (input.files && input.files[0]) {
                        try {
                            const base64 = await Utils.readImage(input.files[0]);
                            document.getElementById('s-logo-data').value = base64;
                            document.getElementById('s-logo-preview').src = base64;
                            document.getElementById('s-logo-preview').style.display = 'block';
                            document.getElementById('s-logo-placeholder').style.display = 'none';
                        } catch (e) {
                            Utils.toast('Erro ao ler imagem', 'error');
                        }
                    }
                },
                save: (e) => {
                    e.preventDefault();
                    const s = Storage.getSettings();
                    s.nome = document.getElementById('s-nome').value;
                    s.razao = document.getElementById('s-razao').value;
                    s.cnpj = document.getElementById('s-cnpj').value;
                    s.telefone = document.getElementById('s-telefone').value;
                    s.email = document.getElementById('s-email').value;
                    s.instagram = document.getElementById('s-instagram').value;
                    s.endereco = document.getElementById('s-endereco').value;
                    s.pix = document.getElementById('s-pix').value;
                    s.logo = document.getElementById('s-logo-data').value;
                    
                    Storage.saveSettings(s);
                    Utils.toast('Configurações salvas');
                    UI.closeModals();
                }
            },

            whatsapp: {
                openCliente: (id) => {
                    const c = UI.data.clientes.find(x => x.id === id);
                    if(!c) return;
                    const num = c.telefone.replace(/\D/g, '');
                    window.open(`https://wa.me/55${num}`, '_blank');
                },
                openOrcamento: (id) => {
                    const o = UI.data.orcamentos.find(x => x.id === id);
                    const c = UI.data.clientes.find(x => x.id === o.clienteId);
                    const s = Storage.getSettings();
                    
                    const num = c.telefone.replace(/\D/g, '');
                    let msg = `Olá ${c.nome.split(' ')[0]}! Aqui é ${s.nome}.\n\n`;
                    msg += `Segue o orçamento *#${o.numero}* para seu evento (${o.evento}).\n`;
                    msg += `Data: ${Utils.formatDate(o.dataEvento)}\n`;
                    msg += `*Valor: ${Utils.formatCurrency(o.valor)}*\n\n`;
                    msg += `Qualquer dúvida estou à disposição!`;
                    
                    window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            },

            pdf: {
                generate: (id) => {
                    const o = UI.data.orcamentos.find(x => x.id === id);
                    const c = UI.data.clientes.find(x => x.id === o.clienteId);
                    const s = Storage.getSettings();
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // --- CONFIGURAÇÕES ---
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = { left: 15, right: 15, top: 20, bottom: 20 };
                    const contentWidth = pageWidth - margin.left - margin.right;
                    let yPos = margin.top;
                    
                    // --- CORES ---
                    const primaryColor = [59, 130, 246];
                    const lightGray = [241, 245, 249];
                    
                    // --- CABEÇALHO ---
                    // Barra superior colorida
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, pageWidth, 25, 'F');
                    
                    // Logo
                    if (s.logo) {
                        try {
                            doc.addImage(s.logo, 'PNG', margin.left, 5, 15, 15);
                        } catch (e) {
                            console.log("Erro ao carregar logo:", e);
                        }
                    }
                    
                    // Nome da empresa (branco sobre fundo azul)
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(s.nome.toUpperCase(), margin.left + (s.logo ? 20 : 0), 12);
                    
                    // Informações de contato à direita
                    doc.setFontSize(7);
                    doc.setFont("helvetica", "normal");
                    doc.text(s.telefone || "", pageWidth - margin.right, 8, { align: "right" });
                    doc.text(s.email || "", pageWidth - margin.right, 12, { align: "right" });
                    doc.text(s.instagram || "", pageWidth - margin.right, 16, { align: "right" });
                    
                    yPos = 35;
                    
                    // --- TÍTULO DO ORÇAMENTO ---
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "bold");
                    doc.text(`ORÇAMENTO #${o.numero}`, pageWidth / 2, yPos, { align: "center" });
                    
                    yPos += 10;
                    
                    // --- CLIENTE ---
                    doc.setDrawColor(200, 200, 200);
                    doc.setFillColor(...lightGray);
                    doc.roundedRect(margin.left, yPos, contentWidth, 15, 2, 2, 'F');
                    
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text("CLIENTE", margin.left + 5, yPos + 5);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.setFont("helvetica", "bold");
                    doc.text(c.nome, margin.left + 5, yPos + 11);
                    
                    yPos += 20;
                    
                    // --- DETALHES DO EVENTO ---
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.setFont("helvetica", "bold");
                    doc.text("DETALHES DO EVENTO", margin.left, yPos);
                    
                    yPos += 7;
                    
                    // Grid de detalhes
                    const drawDetail = (label, value, x, y) => {
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        doc.text(label, x, y);
                        doc.setFontSize(9);
                        doc.setTextColor(0);
                        doc.text(value || "-", x, y + 4);
                    };
                    
                    drawDetail("TIPO", o.evento, margin.left, yPos);
                    drawDetail("DATA", Utils.formatDate(o.dataEvento), margin.left + 60, yPos);
                    drawDetail("HORÁRIO", o.horario || "-", margin.left + 120, yPos);
                    
                    yPos += 10;
                    drawDetail("LOCAL", o.local || "A definir", margin.left, yPos);
                    
                    yPos += 15;
                    
                    // --- SERVIÇOS E VALOR ---
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.setFont("helvetica", "bold");
                    doc.text("SERVIÇOS INCLUÍDOS", margin.left, yPos);
                    
                    yPos += 7;
                    
                    // Tabela simples
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin.left, yPos, margin.left + contentWidth, yPos);
                    
                    // Cabeçalho da tabela
                    doc.setFillColor(...primaryColor);
                    doc.rect(margin.left, yPos, contentWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "bold");
                    doc.text("DESCRIÇÃO", margin.left + 5, yPos + 5.5);
                    doc.text("VALOR", margin.left + contentWidth - 25, yPos + 5.5, { align: "right" });
                    
                    yPos += 8;
                    
                    // Conteúdo da tabela
                    doc.setFillColor(255, 255, 255);
                    doc.rect(margin.left, yPos, contentWidth, 10, 'F');
                    doc.setTextColor(0);
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "normal");
                    
                    const descricao = o.descricao || "Serviços de DJ, som e iluminação";
                    const lines = doc.splitTextToSize(descricao, contentWidth - 60);
                    
                    // Primeira linha
                    doc.text(lines[0], margin.left + 5, yPos + 6);
                    doc.setFont("helvetica", "bold");
                    doc.text(Utils.formatCurrency(o.valor), margin.left + contentWidth - 5, yPos + 6, { align: "right" });
                    
                    // Linhas adicionais
                    for (let i = 1; i < lines.length; i++) {
                        yPos += 4;
                        doc.setFont("helvetica", "normal");
                        doc.text(lines[i], margin.left + 5, yPos + 6);
                    }
                    
                    yPos += 10;
                    
                    // Linha do total
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin.left, yPos, margin.left + contentWidth, yPos);
                    
                    doc.setFillColor(...lightGray);
                    doc.rect(margin.left, yPos, contentWidth, 10, 'F');
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("TOTAL", margin.left + 5, yPos + 6.5);
                    doc.text(Utils.formatCurrency(o.valor), margin.left + contentWidth - 5, yPos + 6.5, { align: "right" });
                    
                    yPos += 15;
                    
                    // --- CLÁUSULAS COMPACTAS ---
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.setFont("helvetica", "bold");
                    doc.text("CONDIÇÕES E CLÁUSULAS", margin.left, yPos);
                    
                    yPos += 7;
                    
                    // Cláusulas compactadas
                    const clausulas = (s.clausulasContrato || `1. O presente orçamento tem validade de 15 dias a partir da data de emissão.
2. Para reserva da data, será necessário o pagamento de 50% do valor total como sinal.
3. O pagamento do saldo restante deverá ser efetuado até o dia do evento.
4. Em caso de cancelamento pelo contratante com menos de 30 dias do evento, o sinal não será devolvido.
5. O profissional se compromete a chegar ao local do evento com 2 horas de antecedência para montagem e testes.
6. O horário de término do serviço será conforme acordado, com tolerância máxima de 30 minutos.
7. O contratante é responsável por fornecer ponto de energia adequado e seguro.
8. Em caso de eventos em locais abertos, é necessária proteção contra chuva para o equipamento.
9. O repertório será definido em conjunto com o contratante, respeitando a classificação indicativa.
10. O som e iluminação serão ajustados conforme as normas do local e legislação vigente.`).split('\n');
                    
                    doc.setFontSize(7);
                    doc.setTextColor(0);
                    doc.setFont("helvetica", "normal");
                    
                    clausulas.forEach((clausula, index) => {
                        // Verificar se ainda cabe na página
                        if (yPos > pageHeight - 30) {
                            doc.addPage();
                            yPos = margin.top;
                        }
                        
                        const lines = doc.splitTextToSize(clausula.trim(), contentWidth);
                        lines.forEach(line => {
                            doc.text(line, margin.left, yPos);
                            yPos += 4;
                        });
                        yPos += 2; // Espaço entre cláusulas
                    });
                    
                    yPos += 5;
                    
                    // --- FORMAS DE PAGAMENTO ---
                    if (yPos < pageHeight - 30) {
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.5);
                        doc.roundedRect(margin.left, yPos, contentWidth, 12, 2, 2);
                        
                        doc.setFontSize(8);
                        doc.setTextColor(...primaryColor);
                        doc.text("FORMA DE PAGAMENTO", margin.left + 5, yPos + 5);
                        
                        doc.setFontSize(7);
                        doc.setTextColor(0);
                        doc.text(`PIX: ${s.pix || "Informar"}`, margin.left + 5, yPos + 9);
                        doc.text("Dinheiro / Cartão", margin.left + 100, yPos + 9);
                        
                        yPos += 15;
                    }
                    
                    // --- ASSINATURAS ---
                    const signatureY = pageHeight - 25;
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.3);
                    doc.line(margin.left + 20, signatureY, margin.left + 80, signatureY);
                    doc.line(margin.left + 110, signatureY, margin.left + 170, signatureY);
                    
                    doc.setFontSize(7);
                    doc.setFont("helvetica", "normal");
                    doc.text(s.nome, margin.left + 50, signatureY + 5, { align: "center" });
                    doc.text("Contratante", margin.left + 140, signatureY + 5, { align: "center" });
                    
           
                    // --- RODAPÉ ---
                    doc.setFontSize(6);
                    doc.setTextColor(150);
                    doc.text(`${s.razao} | CNPJ: ${s.cnpj} | ${s.endereco.replace(/\n/g, ' ') || ''}`, pageWidth / 2, pageHeight - 5, { align: "center" });
                    
                    doc.save(`Orcamento_${o.numero}.pdf`);
                    Utils.toast('PDF baixado com sucesso!');
                }
            },

            backup: {
                exportData: () => {
                    const data = {
                        clientes: UI.data.clientes,
                        orcamentos: UI.data.orcamentos,
                        settings: Storage.getSettings()
                    };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_dj_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                },
                importTrigger: () => document.getElementById('import-file').click(),
                importData: (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if(data.clientes) Storage.set('clientes', data.clientes);
                            if(data.orcamentos) Storage.set('orcamentos', data.orcamentos);
                            if(data.settings) Storage.saveSettings(data.settings);
                            location.reload();
                        } catch(err) {
                            Utils.toast('Erro no arquivo', 'error');
                        }
                    };
                    reader.readAsText(file);
                },
                clearData: () => {
                    if(confirm('Tem certeza? Isso apagará TUDO!')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            }
        };

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if(e.target === overlay) UI.closeModals();
            });
        });

        document.addEventListener('DOMContentLoaded', UI.init);
    </script>
</body>
</html>
